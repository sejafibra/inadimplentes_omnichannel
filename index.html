<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Inadimplentes – Debug</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body{background:#f8f9fa;font-family:Segoe UI, Roboto, Arial;}
    .main-card{max-width:900px;margin:30px auto;padding-bottom:20px;position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
    .main-card img{display:block;margin:18px auto;height:55px;object-fit:contain}
    .nav-tabs .nav-link.active{background:#0d6efd;color:#fff;border:none}
    .copy-box{background:#fff;border:1px solid #ddd;padding:8px;border-radius:6px;margin-bottom:10px;font-family:monospace}
    .log-area{background:#0b1220;color:#9ad; padding:10px; border-radius:6px; font-family:monospace; height:120px; overflow:auto}
  </style>
</head>
<body>

<div class="card main-card" id="loginCard">
  <img src="https://sejafibra.net/wp-content/uploads/2023/06/logonovofibra.png">
  <div class="card-body">
    <h5 class="text-center mb-3">Login</h5>
    <label class="form-label">E-mail</label>
    <input id="email" class="form-control" type="email">
    <label class="form-label mt-3">Senha</label>
    <input id="senha" class="form-control" type="password">
    <button id="entrar" class="btn btn-primary w-100 mt-3">Entrar</button>
    <div id="msgLogin" class="text-danger text-center mt-2"></div>
  </div>
</div>

<div class="card main-card d-none" id="mainCard">
  <button class="btn btn-danger btn-sm" id="logout" style="position:absolute; right:10px; top:10px">Sair</button>
  <img src="https://sejafibra.net/wp-content/uploads/2023/06/logonovofibra.png">

  <ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#uploadTab">Upload</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#diasTab">Dias de Vencimento</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#clipboardTab">Clipboard</a></li>
  </ul>

  <div class="tab-content p-3">
    <div class="tab-pane fade show active" id="uploadTab">
      <label class="form-label">Arquivo XLS / XLSX</label>
      <input type="file" id="fileInput" accept=".xls,.xlsx" class="form-control">
      <div id="statusUpload" class="mt-3 text-muted">Nenhum arquivo enviado.</div>
      <div class="mt-3">
        <small>Logs (aparecem também no Console do navegador):</small>
        <div id="logArea" class="log-area"></div>
      </div>
    </div>

    <div class="tab-pane fade" id="diasTab">
      <table class="table table-sm table-striped" id="diasTable">
        <thead><tr><th>Dias</th><th>Qtd</th><th>Selecionar</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="gerarSelecao" class="btn btn-primary mt-3 w-100">Gerar Seleção</button>
    </div>

    <div class="tab-pane fade" id="clipboardTab">
      <div id="clipboardList"></div>
    </div>
  </div>
</div>

<script>

/* ----------------------------------
      FIREBASE (mesma config que você já tem)
----------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBKrggbFDpXopUivIumYFQCOJR65IO_4fQ",
  authDomain: "inadimplentes-omnichannel.firebaseapp.com",
  projectId: "inadimplentes-omnichannel",
  storageBucket: "inadimplentes-omnichannel.firebasestorage.app",
  messagingSenderId: "93446481624",
  appId: "1:93446481624:web:5ee3d96a1d8f1565e659ad"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

auth.onAuthStateChanged(user => {
  if (user) {
    loginCard.classList.add("d-none");
    mainCard.classList.remove("d-none");
  } else {
    mainCard.classList.add("d-none");
    loginCard.classList.remove("d-none");
  }
});

entrar.onclick = async () => {
  msgLogin.textContent = "";
  try {
    await auth.signInWithEmailAndPassword(email.value.trim(), senha.value.trim());
  } catch {
    msgLogin.textContent = "Falha no login.";
  }
};
logout.onclick = () => auth.signOut();

/* ----------------------------------
      Conversão: Excel serial -> Date
----------------------------------- */
function excelSerialToDate(serial) {
  // Converte serial Excel (número) para Date
  // base 25569 -> 1970-01-01 offset
  const utc_days = Math.floor(serial - 25569);
  const utc_value = utc_days * 86400;
  const date_info = new Date(utc_value * 1000);
  const fractional = serial - Math.floor(serial);
  const seconds = Math.round(fractional * 86400);
  date_info.setSeconds(date_info.getSeconds() + seconds);
  return date_info;
}

/* ----------------------------------
      Helpers de parsing de data
----------------------------------- */
function tryParseToDate(raw) {
  if (raw === null || raw === undefined || raw === "") return null;

  // 1) Se já é Date
  if (raw instanceof Date && !isNaN(raw.getTime())) return raw;

  // 2) Se for number -> serial Excel
  if (typeof raw === "number" && !isNaN(raw)) {
    return excelSerialToDate(raw);
  }

  // 3) Se for string com só dígitos (ex: "20422") -> tratar como serial também
  if (typeof raw === "string") {
    const s = raw.trim();

    // string apenas números -> serial
    if (/^\d+$/.test(s)) {
      const num = Number(s);
      if (!isNaN(num)) return excelSerialToDate(num);
    }

    // permitir formatos com hora: dd/mm/yyyy hh:mm ou dd/mm/yyyy
    // separar parte de data se existir hora
    const part = s.split(" ")[0];

    // dd/mm/yyyy ou d/m/yy
    let m = part.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if (m) {
      let d = parseInt(m[1], 10);
      let mo = parseInt(m[2], 10);
      let y = parseInt(m[3], 10);
      if (y < 100) y += 2000;
      return new Date(y, mo - 1, d);
    }

    // yyyy-mm-dd ou yyyy/mm/dd
    m = part.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if (m) {
      const y = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10);
      const d = parseInt(m[3], 10);
      return new Date(y, mo - 1, d);
    }

    // se não reconheceu, retorna null
    return null;
  }

  return null;
}

/* ----------------------------------
      Globals
----------------------------------- */
let mapaDias = {};     // { dias: qtd }
let diasSelecionados = []; // array de dias (únicos)

/* ----------------------------------
      PROCESSAMENTO DO UPLOAD
----------------------------------- */
fileInput.addEventListener("change", async () => {
  if (!fileInput.files.length) return;

  const file = fileInput.files[0];
  const arrayBuffer = await file.arrayBuffer();
  const wb = XLSX.read(arrayBuffer, { type: "array" });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });

  mapaDias = {};
  const hoje = new Date();
  const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

  for (let i = 1; i < rows.length; i++) {
    const linha = rows[i];
    const raw = linha ? linha[15] : null; // coluna P -> índice 15

    if (raw === null || raw === undefined || raw === "") continue;

    const dataObj = tryParseToDate(raw);
    if (!dataObj || isNaN(dataObj.getTime())) continue;

    // comparar apenas datas (zerar horas)
    const venc = new Date(dataObj.getFullYear(), dataObj.getMonth(), dataObj.getDate());
    const diffMs = hojeSemHora - venc;
    const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (dias < 0) continue; // datas futuras ignoradas

    // USAR dias como chave (Number)
    mapaDias[dias] = (mapaDias[dias] || 0) + 1;
  }

  statusUpload.textContent = "Arquivo carregado com sucesso.";
  preencherTabelaDias();
});

/* ----------------------------------
      PREENCHER TABELA DIAS (ordem decrescente)
----------------------------------- */
function preencherTabelaDias() {
  const tbody = document.querySelector("#diasTable tbody");
  tbody.innerHTML = "";

  const keys = Object.keys(mapaDias).map(k => Number(k)).sort((a, b) => b - a);

  if (!keys.length) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum dia encontrado.</td></tr>';
    return;
  }

  for (const dia of keys) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${dia}</td>
      <td>${mapaDias[dia]}</td>
      <td><input type="checkbox" class="chk-dia" value="${dia}"></td>
    `;
    tbody.appendChild(tr);
  }
}

/* ----------------------------------
      GERAR SELEÇÃO (APENAS UM ITEM POR DIA SELECIONADO)
----------------------------------- */
gerarSelecao.onclick = () => {
  const checks = document.querySelectorAll(".chk-dia:checked");
  // pegar dias únicos selecionados (sem repetir pela qtd)
  diasSelecionados = Array.from(checks).map(ch => Number(ch.value));

  // ordenar do maior para o menor (opcional)
  diasSelecionados.sort((a, b) => b - a);

  // gerar clipboard com os dias únicos selecionados
  gerarClipboard();

  // abrir aba Clipboard automaticamente
  document.querySelector('[href="#clipboardTab"]').click();
};

/* ----------------------------------
      GERAR CLIPBOARD (max 10 por linha, sem repetições)
----------------------------------- */
function gerarClipboard() {
  const container = document.getElementById("clipboardList");
  container.innerHTML = "";

  if (!diasSelecionados.length) {
    container.innerHTML = "<div class='text-muted'>Nenhuma seleção gerada.</div>";
    return;
  }

  // construir grupos de 10
  let grupo = [];
  let index = 1;
  for (let i = 0; i < diasSelecionados.length; i++) {
    grupo.push(diasSelecionados[i]);
    if (grupo.length === 10 || i === diasSelecionados.length - 1) {
      const texto = grupo.join(",");
      const box = document.createElement("div");
      box.className = "copy-box";
      box.innerHTML = `
        <strong>Lista ${index}:</strong> ${texto}
        <button class="btn btn-sm btn-outline-primary float-end copiarBtn">Copiar</button>
      `;

      const btn = box.querySelector(".copiarBtn");
      btn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(texto);
          btn.textContent = "Copiado!";
          setTimeout(() => (btn.textContent = "Copiar"), 1200);
        } catch (e) {
          // fallback simples
          const ta = document.createElement("textarea");
          ta.value = texto;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
      };

      container.appendChild(box);
      index++;
      grupo = [];
    }
  }
}

</script>
